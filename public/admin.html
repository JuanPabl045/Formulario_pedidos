<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel Admin - Molino Viejo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #F2DCD9 0%, #DA2A30 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      padding: 0;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(to right, #DA2A30, #B96454);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
    }

    .content {
      padding: 30px;
    }

    /* Login */
    .login-box {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    /* Tabla de pedidos */
    .table-container {
      overflow-x: auto;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .pedidos-table {
      width: 100%;
      margin-top: 20px;
    }

    .pedidos-table th {
      background: #DA2A30;
      color: white;
      font-weight: 600;
      padding: 15px;
      white-space: nowrap;
    }

    .pedidos-table td {
      padding: 12px 15px;
      vertical-align: top;
      border-bottom: 1px solid #e9ecef;
    }

    .pedidos-table tr:hover {
      background-color: #f8f9fa;
    }

    .producto-item {
      padding: 5px 0;
      font-size: 0.9rem;
    }

    .badge-metodo {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-delivery {
      background: #0dcaf0;
      color: white;
    }

    .badge-tienda {
      background: #198754;
      color: white;
    }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #DA2A30;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    .btn-export {
      background: linear-gradient(to right, #198754, #20c997);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-export:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(25, 135, 84, 0.3);
    }

    .btn-logout {
      background: white;
      color: #DA2A30;
      border: 2px solid white;
      padding: 8px 20px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: #f8f9fa;
    }

    #loginSection {
      display: block;
    }

    #adminPanel {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
  </style>
</head>
<body>

  <!-- SECCIÓN LOGIN -->
  <div id="loginSection">
    <div class="login-box">
      <div class="text-center mb-4">
        <i class="fas fa-lock fa-3x" style="color: #DA2A30;"></i>
        <h2 class="mt-3">Panel Admin</h2>
        <p class="text-muted">Molino Viejo</p>
      </div>
      
      <div class="mb-3">
        <label for="emailLogin" class="form-label">Email:</label>
        <input type="email" id="emailLogin" class="form-control" placeholder="admin@molinoviejo.com">
      </div>
      
      <div class="mb-3">
        <label for="passwordLogin" class="form-label">Contraseña:</label>
        <input type="password" id="passwordLogin" class="form-control">
      </div>
      
      <button class="btn btn-primary w-100" onclick="login()">
        <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
      </button>
      
      <div id="loginError" class="alert alert-danger mt-3" style="display:none;"></div>
    </div>
  </div>

  <!-- PANEL ADMIN -->
  <div id="adminPanel">
    <div class="admin-container">
      <div class="header">
        <div>
          <h1><i class="fas fa-clipboard-list me-2"></i> Panel de Pedidos</h1>
          <small>Molino Viejo</small>
        </div>
        <div>
  <a href="nosotros.html" style="color: white; text-decoration: none; margin-right: 20px;"><i class="fas fa-home me-1"></i> Inicio</a>
  <a href="nosotros.html" style="color: white; text-decoration: none; margin-right: 20px;"><i class="fas fa-drumstick-bite me-1"></i> Carnes</a>
  <a href="pedidos.html" style="color: white; text-decoration: none; margin-right: 20px;"><i class="fas fa-shopping-cart me-1"></i> Pedidos</a>
</div>
<button class="btn btn-logout" onclick="logout()">
          <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
        </button>
      </div>
      
      <div class="content">
        <!-- Estadísticas -->
        <div class="stats-cards">
          <div class="stat-card">
            <div class="stat-number" id="totalPedidos">0</div>
            <div class="stat-label">Total Pedidos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pedidosHoy">0</div>
            <div class="stat-label">Hoy</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pedidosDelivery">0</div>
            <div class="stat-label">Delivery</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pedidosTienda">0</div>
            <div class="stat-label">Recojo en Tienda</div>
          </div>
        </div>

        <!-- Botón exportar -->
        <div class="mb-4">
          <button class="btn btn-export" onclick="exportarExcel()">
            <i class="fas fa-file-excel me-2"></i> Exportar a Excel
          </button>
        </div>

        <!-- Tabla de pedidos -->
        <div class="table-container">
          <table class="table pedidos-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Productos</th>
                <th>Método Entrega</th>
                <th>Dirección</th>
              </tr>
            </thead>
            <tbody id="tablaPedidos">
              <tr>
                <td colspan="5" class="loading">
                  <i class="fas fa-spinner fa-spin fa-2x"></i>
                  <p>Cargando pedidos...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // Configuración Firebase (la misma que index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCFvAXW--jQkrvmK0jHEPtTyAUmWQqQ7y4",
      authDomain: "studio-8205095748-bad39.firebaseapp.com",
      projectId: "studio-8205095748-bad39",
      storageBucket: "studio-8205095748-bad39.firebasestorage.app",
      messagingSenderId: "187526350487",
      appId: "1:187526350487:web:f3c29edc80cfb6d71f8bd2"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let pedidosData = [];

    // Login
    function login() {
      const email = document.getElementById('emailLogin').value.trim();
      const password = document.getElementById('passwordLogin').value.trim();
      
      if (!email || !password) {
        mostrarError("Ingresa email y contraseña");
        return;
      }

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          cargarPedidos();
        })
        .catch(error => {
          mostrarError("Error: " + error.message);
        });
    }

    // Logout
    function logout() {
      auth.signOut().then(() => {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
      });
    }

    // Mostrar error de login
    function mostrarError(mensaje) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = mensaje;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // Cargar pedidos desde Firestore
    function cargarPedidos() {
      db.collection("pedidos")
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          pedidosData = [];
          const tbody = document.getElementById('tablaPedidos');
          tbody.innerHTML = '';

          if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay pedidos aún</td></tr>';
            actualizarEstadisticas();
            return;
          }

          snapshot.forEach(doc => {
            const pedido = doc.data();
            pedido.id = doc.id;
            pedidosData.push(pedido);

            const tr = document.createElement('tr');
            
            // Fecha
            const fecha = pedido.timestamp ? pedido.timestamp.toDate() : new Date();
            const fechaStr = fecha.toLocaleString('es-PE', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            // Productos
            let productosHTML = '';
            if (pedido.productos && Array.isArray(pedido.productos)) {
              pedido.productos.forEach(p => {
                productosHTML += `<div class="producto-item">• ${p.cantidad}x ${p.producto}</div>`;
              });
            }

            // Método entrega
            const esDelivery = pedido.metodoEntrega === 'Delivery';
            const badgeClass = esDelivery ? 'badge-delivery' : 'badge-tienda';
            const metodoHTML = `<span class="badge-metodo ${badgeClass}">${pedido.metodoEntrega}</span>`;

            // Dirección
            const direccionHTML = esDelivery ? (pedido.direccion || '-') : '-';

            tr.innerHTML = `
              <td>${fechaStr}</td>
              <td><strong>${pedido.nombre}</strong></td>
              <td>${productosHTML}</td>
              <td>${metodoHTML}</td>
              <td>${direccionHTML}</td>
            `;

            tbody.appendChild(tr);
          });

          actualizarEstadisticas();
        });
    }

    // Actualizar estadísticas
    function actualizarEstadisticas() {
      const total = pedidosData.length;
      
      // Pedidos de hoy
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const pedidosHoy = pedidosData.filter(p => {
        const fecha = p.timestamp ? p.timestamp.toDate() : new Date();
        fecha.setHours(0, 0, 0, 0);
        return fecha.getTime() === hoy.getTime();
      }).length;

      // Por método de entrega
      const delivery = pedidosData.filter(p => p.metodoEntrega === 'Delivery').length;
      const tienda = total - delivery;

      document.getElementById('totalPedidos').textContent = total;
      document.getElementById('pedidosHoy').textContent = pedidosHoy;
      document.getElementById('pedidosDelivery').textContent = delivery;
      document.getElementById('pedidosTienda').textContent = tienda;
    }

    // Exportar a Excel
    function exportarExcel() {
      if (pedidosData.length === 0) {
        alert('No hay pedidos para exportar');
        return;
      }

      // Preparar datos para Excel
      const excelData = pedidosData.map(pedido => {
        const fecha = pedido.timestamp ? pedido.timestamp.toDate() : new Date();
        
        // Concatenar productos
        let productos = '';
        if (pedido.productos && Array.isArray(pedido.productos)) {
          productos = pedido.productos.map(p => 
            `${p.cantidad}x ${p.producto} - ${p.descripcion || 'Sin detalles'}`
          ).join(' | ');
        }

        return {
          'Fecha': fecha.toLocaleString('es-PE'),
          'Cliente': pedido.nombre,
          'Productos': productos,
          'Método Entrega': pedido.metodoEntrega,
          'Dirección': pedido.direccion || '',
          'Link Maps': pedido.mapsLink || '',
          'Estado': pedido.estado || 'pendiente'
        };
      });

      // Crear libro Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);

      // Ajustar anchos de columna
      ws['!cols'] = [
        { wch: 20 }, // Fecha
        { wch: 25 }, // Cliente
        { wch: 50 }, // Productos
        { wch: 18 }, // Método
        { wch: 40 }, // Dirección
        { wch: 40 }, // Maps
        { wch: 12 }  // Estado
      ];

      XLSX.utils.book_append_sheet(wb, ws, "Pedidos");

      // Descargar archivo
      const nombreArchivo = `Pedidos_MolinoViejo_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, nombreArchivo);
    }

    // Verificar sesión al cargar
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        cargarPedidos();
      } else {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
      }
    });
  </script>
</body>
</html>

